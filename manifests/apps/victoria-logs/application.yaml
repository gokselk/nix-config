apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: victoria-logs
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "5"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    - repoURL: https://github.com/goksel/nix-config
      targetRevision: HEAD
      path: manifests/apps/victoria-logs
    - repoURL: https://victoriametrics.github.io/helm-charts
      chart: victoria-logs-single
      targetRevision: 0.8.14
      helm:
        valuesObject:
          server:
            retentionPeriod: 14d
            persistentVolume:
              enabled: true
              storageClassName: local-path
              size: 20Gi
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 1Gi

          fluent-bit:
            enabled: true
            config:
              outputs: |
                [OUTPUT]
                    Name http
                    Match kube.*
                    Host {{ .Release.Name }}-server
                    port 9428
                    uri /insert/jsonline?_stream_fields=stream,kubernetes_pod_name,kubernetes_container_name,kubernetes_namespace_name&_msg_field=log&_time_field=date
                    format json_lines
                    json_date_format iso8601
                    compress gzip
              filters: |
                [FILTER]
                    Name kubernetes
                    Match kube.*
                    Merge_Log On
                    Keep_Log Off
                    K8S-Logging.Parser On
                    K8S-Logging.Exclude On

                [FILTER]
                    Name nest
                    Match kube.*
                    Operation lift
                    Nested_under kubernetes
                    Add_prefix kubernetes_

                [FILTER]
                    Name modify
                    Match kube.*
                    Remove kubernetes_labels
                    Remove kubernetes_annotations
            resources:
              requests:
                cpu: 20m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 256Mi
  destination:
    server: https://kubernetes.default.svc
    namespace: logging
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
